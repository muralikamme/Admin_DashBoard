{{>headers}}

<section id="content">

<title>Hot Deals</title>

<div class="row p-2" style="margin: 0px !important;">
    <div class="col-md-12">
        <div class="card mt-2">
            {{!-- <div class="alert-success">{{success}}</div>
            <div class="alert-danger">{{error}}</div> --}}
            <div class="card-header" style="background-color:white; color:black;">
                <h4><b>Deals</b></h4>
            </div>
            <div class="card-body p-2">
                <div id="example1_wrapper">
                    <div class="row">
                        <div class="col-sm-12">
                            <ol class="float-sm-right">
                                <button href="" id="" data-bs-toggle="modal" data-bs-target="#addModal"
                                    style="background-color: rgb(0, 0, 0); color:white; border:none; border-radius:5px; width: 180px; height: 40px; "><i
                                        class="fa-solid fa-plus"></i> Add Deals</button>
                            </ol>
                        </div>
                        <div class="col-sm-12 table-responsive">
                            <table id="example2" aria-describedby="example1_info">
                                <thead>
                                    <tr>
                                        <th class="sorting" tabindex="0" aria-controls="example1">S.No</th>
                                        <th class="sorting" tabindex="0" aria-controls="example1">Image</th>
                                        <th class="sorting" tabindex="0" aria-controls="example1">Name</th>
                                        <th class="sorting" tabindex="0" aria-controls="example1">Layout</th>
                                        {{!-- <th class="sorting" tabindex="0" aria-controls="example1">Products</th> --}}
                                        <th class="sorting" tabindex="0" aria-controls="example1">status</th>
                                        <th class="sorting" tabindex="0" aria-controls="example1">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each allHotDeals}}
                                    <tr class="odd">
                                        <td>{{inc @index}}</td>
                                        <td><img src="/{{this.picture}}" alt="Image"
                                                style="max-width: 150px; height: 150px;"></td>
                                        <td>{{this.name}}</td>
                                        <td>{{this.layout}}</td>
                                        {{!-- <td>
                                            {{#each this.products}}
                                                {{this.name}} </br>
                                            {{/each}}
                                        </td> --}}
                                        <td>{{this.status}}</td>
                                        <td>
                                            <div class="eye d-flex justify-content-center">
                                            <a class="btn btn-md btn-warning m-1" href="/admin/singledeal/{{this._id}}">
                                                <i class="fa-solid fa-eye text-black"></i>
                                            </a>
                                            <button class="btn btn-md btn-warning m-1" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#updateModal"
                                                    data-id="{{_id}}" 
                                                    data-name="{{name}}" 
                                                    data-dealPicture="{{dealPicture}}" 
                                                    data-status="{{status}}" 
                                                    data-layout="{{layout}}" 
                                                    data-products='{{json products}}'>
                                                <i class="fa-solid fa-edit text-black"></i>
                                            </button>
                                                <a href="javascript:void(0);" data-bs-toggle="modal"
                                                    data-id="{{this._id}}" data-bs-target="#deleteModal"
                                                    class="btn btn-md btn-warning m-1">
                                                    <i class="fa-solid fa-trash text-red"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {{/each}}
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{>footer}}

<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 style="color: black; font-weight: bold; font-size: 40px;">Add Deal</h5>
                <!-- Close Button -->
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addDeal" action="/admin/adddeal" method="post" enctype="multipart/form-data"
                id="addDealForm" onsubmit="changeButtonState()">

                <div class="modal-body">
                    <div>
                        <label for="name">Name*</label>
                        <input type="text" class="form-control" name="name" required
                            placeholder="Enter Name" minlength="3" maxlength="40">
                    </div>
                   <div class="form-group mt-3">
                        <label for="products">Select Products*</label>
                        <select name="products" id="addProductsSelect" multiple>
                            {{#each allProducts}}
                                <option value="{{this._id}}">{{this.name}}-{{this.productId}}</option>
                            {{/each}}
                        </select>
                    </div>
                   <div class="form-group mt-3">
                        <label for="layout">Select Layout*</label>
                        <select name="layout" class="form-control" id="layout" required>
                                <option value="" selected disabled>select</option>
                                <option value="grid">Grid</option>
                                <option value="list">List</option>
                        </select>
                    </div>
                    <label for="dealPicture">Deal*</label>
                    <input type="file" class="form-control" name="picture" id="dealPicture"
                        placeholder="Upload new banner image" accept=".jpg, .jpeg, .png" required>
                    <small id="charCount">Recommended dimensions: 4:3 eg(1200:900 px), etc.</small>
                    <small id="error-message" style="color: red; display: none;">Invalid file type or dimensions. Please
                        upload a valid image.</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="addButton">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: black; font-weight: bold;">Update Deal</h3>
            </div>
            
            <form action="/admin/updatedeal/{{this._id}}" method="post" enctype="multipart/form-data"
                id="updateDealForm">
                <div class="modal-body">
                    <div>
                        <label for="name">Name</label>
                        <input type="text" class="form-control" id="editName" name="name" required
                            placeholder="Enter Name" minlength="3" maxlength="40">
                    </div>

                    <div class="form-group mt-3">
                        <label for="products">Select Products</label>
                        <select name="products" id="updateProductsSelect" multiple required>
                        {{#each allProducts}}
                            <option value="{{this._id}}">
                            {{this.name}}{{#if this.productId}} - {{this.productId}}{{/if}}
                            </option>
                        {{/each}}
                        </select>
                    </div>
                    <div class="form-group mt-3">
                        <label for="layout">Select Layout</label>
                        <select name="layout" class="form-control" id="updateLayout" required>
                                <option value="" selected disabled>Select</option>
                                <option value="grid">Grid</option>
                                <option value="list">List</option>
                        </select>
                    </div>
                    <label for="dealPicture">Deal Picture</label>
                    <input type="file" class="form-control" name="dealPicture" {{!-- id="bannerPicture" --}}
                        accept=".jpg, .jpeg, .png" placeholder="Upload new image" {{!--
                        onchange="validateImage()" --}}>
                    <small id="charCount">Image should be 4:3 (e.g., 1200x900) under 2mb, etc.,</small><br><br>
                    <div id="imageError" style="color: red; display: none">Invalid image dimensions. Please upload an
                        image with dimensions 4:3 (e.g., 1200x900) px.</div>
                    <label for="status">Status</label>
                    <select name="status" class="form-control">
                        <option value="Active">Active</option>
                        <option value="In-Active">Inactive</option>
                    </select>
                </div>
                 <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" id="updateButton" class="btn btn-info">Update</button>
        </div>
            </form>
        </div>
    </div>
</div>

<script>
    const validFileTypes = ['image/jpeg', 'image/png', 'image/jpg'];
    const maxSize = 2 * 1024 * 1024; // 2MB
    const aspectRatioTolerance = 4;

    const addForm = document.getElementById('addDeal');
    const updateForm = document.getElementById('updateDealForm');
    const addInput = document.getElementById('dealPicture');
    const updateInput = updateForm.querySelector('input[name="dealPicture"]');
    const addError = document.getElementById('error-message');
    const updateError = document.getElementById('imageError');
    const addButton = document.getElementById('addButton');
    const updateButton = document.getElementById('updateButton');

    // Only letters and spaces (3-40 characters)
    function validateName(input) {
        const value = input.value.trim();
        const regex = /^(?=.*[A-Za-z]).{3,50}$/;
        return regex.test(value);
    }

    function validateImage(file, errorContainer, callback) {
        if (!file) {
            errorContainer.style.display = 'none';
            callback(false);
            return;
        }

        if (!validFileTypes.includes(file.type)) {
            errorContainer.textContent = 'Invalid file type. Please upload .jpg, .jpeg, or .png.';
            errorContainer.style.display = 'block';
            callback(false);
            return;
        }

        if (file.size > maxSize) {
            errorContainer.textContent = 'File size must not exceed 2 MB.';
            errorContainer.style.display = 'block';
            callback(false);
            return;
        }

        const img = new Image();
        img.onload = function () {
            const validAspect = Math.abs(img.width * 3 - img.height * 4) <= aspectRatioTolerance;

            if (!validAspect) {
                errorContainer.textContent = 'Invalid aspect ratio. Image should be 4:3 (e.g., 1200x900).';
                errorContainer.style.display = 'block';
                callback(false);
            } else {
                errorContainer.style.display = 'none';
                callback(true);
            }
        };
        img.src = URL.createObjectURL(file);
    }

    // Handle Add Form Submission
    addForm.addEventListener('submit', function (e) {
    const nameInput = addForm.querySelector('input[name="name"]');
    const file = addInput.files[0];

    if (!validateName(nameInput)) {
        e.preventDefault();
        alert("Invalid name. it should contain at least one letter (3–50 characters).");
        return;
    }
    const productsSelect = document.getElementById('addProductsSelect');
     if (productsSelect.selectedOptions.length === 0) {
        e.preventDefault();
        alert("Please select at least one product.");
        return;
    }
    validateImage(file, addError, function (isValid) {
        if (!isValid) {
            e.preventDefault();
            return;
        }

        nameInput.value = nameInput.value.trim();
        addButton.textContent = 'Adding...';
        addButton.disabled = true;
    });
});


    // Handle Update Form Submission
    updateForm.addEventListener('submit', function (e) {
        const nameInput = updateForm.querySelector('input[name="name"]');

        if (!validateName(nameInput)) {
            e.preventDefault();
            alert("Invalid name. Only letters and spaces (3–40 characters).");
            return;
        }
        nameInput.value = nameInput.value.trim()
        updateButton.textContent = "Updating...";
        updateButton.disabled = true;
    });

    // Image preview triggers validation
    addInput.addEventListener('change', () => {
        validateImage(addInput.files[0], addError, function (isValid) {
            addButton.disabled = !isValid;
        });
    });

    updateInput.addEventListener('change', () => {
        validateImage(updateInput.files[0], updateError, function (isValid) {
            updateButton.disabled = !isValid;
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
    const addModalEl = document.getElementById('addModal');
    const updateModalEl = document.getElementById('updateModal');

    // When Add Modal closes
    addModalEl.addEventListener('hidden.bs.modal', function () {
        addForm.reset();
        addError.style.display = 'none';
        addButton.disabled = false;
        addButton.textContent = 'Add';

        // Clear Choices.js
        if (addChoices) {
            addChoices.removeActiveItems();
        }

        // Clear file input
        addInput.value = "";
    });

updateModalEl.addEventListener('hidden.bs.modal', function () {
    updateForm.reset();
    updateError.style.display = 'none';
    updateButton.disabled = false;
    updateButton.textContent = 'Update';
    if (updateChoices) {
        updateChoices.removeActiveItems();
    }
    updateInput.value = "";
});
});


    // Reset button state when page loads (e.g., after a failed form submission)
    window.addEventListener('load', function () {
        addButton.disabled = false;
        addButton.textContent = 'Add';
        updateButton.disabled = false;
        updateButton.textContent = 'Update';
    });
</script>



<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 style="color: black; font-weight: 480;">Are you sure you want to delete this deal?</h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <a href="" id="deleteDealLink" type="button" class="btn btn-danger">Yes</a>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        if (!$.fn.DataTable.isDataTable('#example2')) {
            $('#example2').addClass('table table-bordered table-striped').DataTable({
                "paging": true,
            });
        }
    });
</script>
{{!-- update modal --}}



<script>
    $(document).ready(function () {
        $('#deleteModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var dealId = button.data('id');
            var modal = $(this);
            modal.find('#deleteDealLink').attr('href', '/admin/deletedeal/' + dealId);
        });
    });
     document.getElementById('deleteDealLink').addEventListener('click', function(){
        this.style.pointerEvents = "none";
        this.style.cursor = "no-drop"
    })
</script>

<script>
    let addChoices, updateChoices;

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Choices on both selects
        const addSelect = document.getElementById('addProductsSelect');
        const updateSelect = document.getElementById('updateProductsSelect');

        if (addSelect) {
            addChoices = new Choices(addSelect, {
                removeItemButton: true,
                placeholder: true,
                searchPlaceholderValue: 'Search products',
                placeholderValue: 'Select products',
                itemSelectText:''

            });
        }

        if (updateSelect) {
            updateChoices = new Choices(updateSelect, {
                removeItemButton: true,
                placeholder: true,
                searchPlaceholderValue: 'Search products',
                placeholderValue: 'Select products',
                itemSelectText:''

            });
        }

        // When the update modal is shown
        $('#updateModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const modal = $(this);

            const dealId = button.data('id');
            const name = button.data('name');
            const dealPicture = button.data('dealPicture');
            const status = button.data('status');
            const layout = button.data('layout');
            const selectedProducts = button.data('products'); // should be an array of product IDs

            modal.find('form').attr('action', '/admin/updatedeal/' + dealId);
            modal.find('input[name="name"]').val(name);
            modal.find('select[name="status"]').val(status);
            modal.find('select[name="layout"]').val(layout);

            // Clear and set Choices values
            if (updateChoices && Array.isArray(selectedProducts)) {
                updateChoices.removeActiveItems();
                selectedProducts.forEach(productId => {
                    updateChoices.setChoiceByValue(productId._id);
                });
            }
        });
    });
</script>


</body>

</html>
</section>